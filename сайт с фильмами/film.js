/*
const MOCK_DATA = {
     "docs": [
          {
             "internalNames": [
                 "Убить Билла",
                 "Kill Bill: Vol. 1",
                 "Kill Bill 1",
                 "Kill Bill: Volume 1",
                 "Kill Bill, la venganza: Volumen I",
                 "Kiru Biru",
                 "Nuzudyti Bila 1",
                 "Nogalinat Bilu: 1.dala",
                 "Kill Bill: Volumul 1",
                 "Ubiti Bila, prvi deo",
                 "Kill Bill",
                 "杀死比尔：第一卷",
                 "Kill Bill. Volume 1",
                 "Bill'i Öldürmek: Bölüm 1",
                 "Kill Bill Volume1",
                 "Ubiĭ Bil",
                 "Ubit' Billa",
                 "Vbyty Billa: Filʹm 1",
                 "Kill Bill - Volume 1",
                 "Kill Bill Volume 1",
                 "Kill Bill։ Vol. 1",
                 "นางฟ้าซามูไร",
                 "Kill Bill 1 (2003)",
                 "Kill Bill - Volume I",
                 "Kill.Bill.Vol.1",
                 "杀死比尔.1",
                 "Kill Bill Vol 1"
             ],
             "name": "Убить Билла",
             "alternativeName": "Kill Bill: Vol. 1",
             "enName": "",
             "year": 2003,
             "genres": [
                 {
                     "name": "боевик"
                 },
                 {
                     "name": "триллер"
                 },
                 {
                     "name": "криминал"
                 }
             ],
             "countries": [
                 {
                     "name": "США"
                 },
                 {
                     "name": "Япония"
                 }
             ],
             "releaseYears": [],
             "id": 2717,
             "externalId": {
                 "imdb": "tt0266697",
                 "tmdb": 24,
                 "kpHD": "46c570bec3fef7aca68702c5c735049c"
             },
             "names": [
                 {
                     "name": "Убить Билла"
                 },
                 {
                     "name": "Kill Bill: Vol. 1"
                 },
                 {
                     "name": "Kill Bill 1",
                     "language": "GB",
                     "type": null
                 },
                 {
                     "name": "Kill Bill: Volume 1",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "Kill Bill, la venganza: Volumen I",
                     "language": "AR",
                     "type": null
                 },
                 {
                     "name": "Kiru Biru",
                     "language": "JP",
                     "type": "Romaji"
                 },
                 {
                     "name": "Nuzudyti Bila 1",
                     "language": "LT",
                     "type": null
                 },
                 {
                     "name": "Nogalinat Bilu: 1.dala",
                     "language": "LV",
                     "type": null
                 },
                 {
                     "name": "Kill Bill: Volumul 1",
                     "language": "RO",
                     "type": null
                 },
                 {
                     "name": "Ubiti Bila, prvi deo",
                     "language": "RS",
                     "type": null
                 },
                 {
                     "name": "Kill Bill",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "杀死比尔：第一卷",
                     "language": "CN",
                     "type": null
                 },
                 {
                     "name": "Kill Bill. Volume 1",
                     "language": "ES",
                     "type": null
                 },
                 {
                     "name": "Bill'i Öldürmek: Bölüm 1",
                     "language": "TR",
                     "type": null
                 },
                 {
                     "name": "Kill Bill Volume1",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "Ubiĭ Bil",
                     "language": "BG",
                     "type": null
                 },
                 {
                     "name": "Ubit' Billa",
                     "language": "RU",
                     "type": null
                 },
                 {
                     "name": "Vbyty Billa: Filʹm 1",
                     "language": "UA",
                     "type": null
                 },
                 {
                     "name": "Kill Bill - Volume 1",
                     "language": "IT",
                     "type": null
                 },
                 {
                     "name": "Kill Bill Volume 1",
                     "language": "FR",
                     "type": null
                 },
                 {
                     "name": "Kill Bill։ Vol. 1",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "นางฟ้าซามูไร",
                     "language": "TH",
                     "type": null
                 },
                 {
                     "name": "Kill Bill 1 (2003)",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "Kill Bill - Volume I",
                     "language": "FR",
                     "type": null
                 },
                 {
                     "name": "Kill.Bill.Vol.1",
                     "language": "CN",
                     "type": null
                 },
                 {
                     "name": "杀死比尔.1",
                     "language": "CN",
                     "type": null
                 },
                 {
                     "name": "Kill Bill Vol 1",
                     "language": "CA",
                     "type": null
                 }
             ],
             "type": "movie",
             "description": "В беременную наёмную убийцу по кличке Чёрная Мамба во время бракосочетания стреляет человек по имени Билл. Но голова у женщины оказалась крепкой — пролежав четыре года в коме, бывшая невеста приходит в себя. Она горит желанием найти предателей. Теперь только безжалостная месть успокоит сердце Чёрной Мамбы, и она начинает по очереди убивать членов банды Билла, решив оставить главаря напоследок.",
             "shortDescription": "Наемная убийца жестоко мстит бывшим подельникам. Жестокий боевик Квентина Тарантино — с анимацией и отсылками",
             "logo": {
                 "url": "https://avatars.mds.yandex.net/get-ott/2385704/2a0000016fc34960ad93f63ad1fd539a7b4e/orig"
             },
             "poster": {
                 "url": "https://image.openmoviedb.com/kinopoisk-images/1599028/c28ed8ad-54b7-4781-8f42-002d26b39b7f/orig",
                 "previewUrl": "https://image.openmoviedb.com/kinopoisk-images/1599028/c28ed8ad-54b7-4781-8f42-002d26b39b7f/x1000"
             },
             "backdrop": {
                 "url": "https://image.openmoviedb.com/kinopoisk-ott-images/223007/2a0000016224ee88f458810605561bbe7a2d/orig",
                 "previewUrl": "https://image.openmoviedb.com/kinopoisk-ott-images/223007/2a0000016224ee88f458810605561bbe7a2d/x1000"
             },
             "rating": {
                 "kp": 7.695,
                 "imdb": 8.2,
                 "filmCritics": 7.7,
                 "russianFilmCritics": 80,
                 "await": null
             },
             "votes": {
                 "kp": 311536,
                 "imdb": 1204099,
                 "filmCritics": 238,
                 "russianFilmCritics": 5,
                 "await": 0
             },
             "movieLength": 111,
             "internalRating": 7.695,
             "internalVotes": 311536,
             "isSeries": false,
             "ticketsOnSale": false,
             "totalSeriesLength": null,
             "seriesLength": null,
             "ratingMpaa": "r",
             "ageRating": 18,
             "top10": null,
             "top250": 152,
             "typeNumber": 1,
             "status": null
         },
         {
             "internalNames": [
                 "Убить Билла 2",
                 "Kill Bill: Vol. 2",
                 "Kill Bill - Vol. 2",
                 "Ubiti Bila, drugi deo",
                 "Kill Bill 2",
                 "Kill Bill, la venganza: Volumen II",
                 "Kill Bill. Volume 2",
                 "Bill'i Öldürmek: Bölüm 2",
                 "Vbyty Billa: Filʹm 2",
                 "킬 빌 2부",
                 "Kill Bill - Volume 2",
                 "Kill Bill Volume 2",
                 "킬 빌 2",
                 "Ubit' Billa 2",
                 "Ubiĭ Bil 2",
                 "Kill Bill Volume 2",
                 "Kill Bill։ Vol. 2",
                 "นางฟ้าซามูไร 2",
                 "Kill Bill 2 (2004)",
                 "Kill Bill 2",
                 "Kill Bill - Volume II",
                 "Kill.Bill.Vol.2",
                 "杀死比尔.2",
                 "Kill Bill Vol 2"
             ],
             "name": "Убить Билла 2",
             "alternativeName": "Kill Bill: Vol. 2",
             "enName": "",
             "year": 2004,
             "genres": [
                 {
                     "name": "боевик"
                 },
                 {
                     "name": "триллер"
                 },
                 {
                     "name": "криминал"
                 }
             ],
             "countries": [
                 {
                     "name": "США"
                 }
             ],
             "releaseYears": [],
             "id": 47015,
             "externalId": {
                 "imdb": "tt0378194",
                 "tmdb": 393,
                 "kpHD": "4ce7ad42a8a7041780c08a58b0b60699"
             },
             "names": [
                 {
                     "name": "Убить Билла 2"
                 },
                 {
                     "name": "Kill Bill: Vol. 2"
                 },
                 {
                     "name": "Kill Bill - Vol. 2",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "Ubiti Bila, drugi deo",
                     "language": "RS",
                     "type": null
                 },
                 {
                     "name": "Kill Bill 2",
                     "language": "GB",
                     "type": null
                 },
                 {
                     "name": "Kill Bill, la venganza: Volumen II",
                     "language": "AR",
                     "type": null
                 },
                 {
                     "name": "Kill Bill. Volume 2",
                     "language": "ES",
                     "type": null
                 },
                 {
                     "name": "Bill'i Öldürmek: Bölüm 2",
                     "language": "TR",
                     "type": null
                 },
                 {
                     "name": "Vbyty Billa: Filʹm 2",
                     "language": "UA",
                     "type": null
                 },
                 {
                     "name": "킬 빌 2부",
                     "language": "KR",
                     "type": null
                 },
                 {
                     "name": "Kill Bill - Volume 2",
                     "language": "IT",
                     "type": null
                 },
                 {
                     "name": "Kill Bill Volume 2",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "킬 빌 2",
                     "language": "KR",
                     "type": null
                 },
                 {
                     "name": "Ubit' Billa 2",
                     "language": "RU",
                     "type": null
                 },
                 {
                     "name": "Ubiĭ Bil 2",
                     "language": "BG",
                     "type": null
                 },
                 {
                     "name": "Kill Bill Volume 2",
                     "language": "FR",
                     "type": null
                 },
                 {
                     "name": "Kill Bill։ Vol. 2",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "นางฟ้าซามูไร 2",
                     "language": "TH",
                     "type": null
                 },
                 {
                     "name": "Kill Bill 2 (2004)",
                     "language": "US",
                     "type": null
                 },
                 {
                     "name": "Kill Bill 2",
                     "language": "BR",
                     "type": null
                 },
                 {
                     "name": "Kill Bill - Volume II",
                     "language": "FR",
                     "type": null
                 },
                 {
                     "name": "Kill.Bill.Vol.2",
                     "language": "CN",
                     "type": null
                 },
                 {
                     "name": "杀死比尔.2",
                     "language": "CN",
                     "type": null
                 },
                 {
                     "name": "Kill Bill Vol 2",
                     "language": "CA",
                     "type": null
                 }
             ],
             "type": "movie",
             "description": "Убив двух человек из банды, Невеста лишь наполовину приблизилась к цели. Теперь на очереди Бад и Элли Драйвер. Еще два опасных шага перед последней схваткой, в которой она должна убить Билла.",
             "shortDescription": "Черная Мамба все ближе к главарю банды. Продолжение синефильского экшена Квентина Тарантино",
             "logo": {
                 "url": "https://avatars.mds.yandex.net/get-ott/2439731/2a000001714e84ca2db80170a68edee3ea1b/orig"
             },
             "poster": {
                 "url": "https://image.openmoviedb.com/kinopoisk-images/1777765/2f8295c3-cc9f-43cf-8dfe-13616c3eaa5e/orig",
                 "previewUrl": "https://image.openmoviedb.com/kinopoisk-images/1777765/2f8295c3-cc9f-43cf-8dfe-13616c3eaa5e/x1000"
             },
             "backdrop": {
                 "url": "https://image.openmoviedb.com/kinopoisk-ott-images/200035/2a000001622509c70392f40247aa1cc8f4dc/orig",
                 "previewUrl": "https://image.openmoviedb.com/kinopoisk-ott-images/200035/2a000001622509c70392f40247aa1cc8f4dc/x1000"
             },
             "rating": {
                 "kp": 7.606,
                 "imdb": 8,
                 "filmCritics": 7.8,
                 "russianFilmCritics": 100,
                 "await": null
             },
             "votes": {
                 "kp": 224993,
                 "imdb": 811960,
                 "filmCritics": 246,
                 "russianFilmCritics": 3,
                 "await": 0
             },
             "movieLength": 137,
             "internalRating": 7.606,
             "internalVotes": 224993,
             "isSeries": false,
             "ticketsOnSale": false,
             "totalSeriesLength": null,
             "seriesLength": null,
             "ratingMpaa": "r",
             "ageRating": 18,
             "top10": null,
             "top250": 240,
             "typeNumber": 1,
             "status": null
         },
         {
             "internalNames": [
                 "Убить Фрейда",
                 "Inconscientes"
             ],
             "name": "Убить Фрейда",
             "alternativeName": "Inconscientes",
             "enName": "",
             "year": 2004,
             "genres": [
                 {
                     "name": "мелодрама"
                 },
                 {
                     "name": "комедия"
                 },
                 {
                     "name": "детектив"
                 }
             ],
             "countries": [
                 {
                     "name": "Испания"
                 },
                 {
                     "name": "Германия"
                 },
                 {
                     "name": "Италия"
                 },
                 {
                     "name": "Португалия"
                 }
             ],
             "releaseYears": [],
             "id": 78834,
             "externalId": {
                 "kpHD": null,
                 "imdb": "tt0395173",
                 "tmdb": 43271
             },
             "names": [
                 {
                     "name": "Убить Фрейда"
                 },
                 {
                     "name": "Inconscientes"
                 }
             ],
             "type": "movie",
             "description": "Барселона, 1913. На сегодняшний день Альма, возможно, самая современная женщина. Ее муж, доктор Леон Пардо - психиатр. Этим летом он поехал в Вену и стал последователем революционного учения доктора Зигмунда Фрейда. Все начинается с того, что, вернувшись домой, Альма застает своего мужа в слезах и решительно настроенного исчезнуть из ее жизни, как и из жизней других тоже.  Не дав никаких объяснений, Леон выбегает из дома, бросив одну Альму, которая должна скоро родить. В Альму безумно влюблен Сальвадор, муж ее сестры. Поэтому он соглашается помочь ей, несмотря на то, что логика подсказывает ему, что его могут поджидать крупные неприятности.  Единственным ключом к происходящему является рукопись об истерии и женской сексуальности, в которой описывается жизнь четырех пациенток. Взяв эту рукопись в качестве путеводителя, Альма и Сальвадор начинают расследование в стиле Шерлока Холмса, в котором переплетаются любовь, опасность и все вообразимые запреты...",
             "shortDescription": "",
             "logo": {
                 "url": "https://image.openmoviedb.com/tmdb-images/original/go7njUqchkKxABIvoTPcz78u1mw.png",
                 "previewUrl": "https://image.openmoviedb.com/tmdb-images/w500/go7njUqchkKxABIvoTPcz78u1mw.png"
             },
             "poster": {
                 "url": "https://image.openmoviedb.com/kinopoisk-images/1600647/5e0e6e0c-ed30-439b-892d-9ea4684b353a/orig",
                 "previewUrl": "https://image.openmoviedb.com/kinopoisk-images/1600647/5e0e6e0c-ed30-439b-892d-9ea4684b353a/x1000"
             },
             "backdrop": {
                 "url": "https://image.openmoviedb.com/tmdb-images/original/h6hvy15g67TlFr3fJh3QWtT6vr3.jpg",
                 "previewUrl": "https://image.openmoviedb.com/tmdb-images/w500/h6hvy15g67TlFr3fJh3QWtT6vr3.jpg"
             },
             "rating": {
                 "kp": 7.385,
                 "imdb": 7.2,
                 "filmCritics": 7.3,
                 "russianFilmCritics": 0,
                 "await": null
             },
             "votes": {
                 "kp": 3806,
                 "imdb": 2218,
                 "filmCritics": 26,
                 "russianFilmCritics": 2,
                 "await": 0
             },
             "movieLength": 100,
             "internalRating": 7.385,
             "internalVotes": 3806,
             "isSeries": false,
             "ticketsOnSale": false,
             "totalSeriesLength": null,
             "seriesLength": null,
             "ratingMpaa": "r",
             "ageRating": 16,
             "top10": null,
             "top250": null,
             "typeNumber": 1,
             "status": null
         },
     ]
 }

 */

/*
const MOCK_VIDEODATA = [
        {
            "source": "Alloha",
            "iframeUrl": "https://sansa.allarknow.online/?token_movie=71b8abf478bd8c7705d5657fb4747f&token=48ac5259825fb8f20103dac69a9029",
            "translations": [
                {
                    "id": 66,
                    "name": "Дублированный",
                    "quality": "BDRip",
                    "iframeUrl": "https://sansa.allarknow.online/?token_movie=71b8abf478bd8c7705d5657fb4747f&translation=66&token=48ac5259825fb8f20103dac69a9029"
                },
                {
                    "id": 63,
                    "name": "Гоблин",
                    "quality": "WEB-DL",
                    "iframeUrl": "https://sansa.allarknow.online/?token_movie=71b8abf478bd8c7705d5657fb4747f&translation=63&token=48ac5259825fb8f20103dac69a9029"
                }
            ],
            "success": true,
            "updatedAt": "2024-12-03T22:50:26.2710482Z"
        },
        {
            "source": "Turbo",
            "iframeUrl": "https://92d73433.obrut.show/embed/MjM/content/ADOzITN",
            "translations": [
                {
                    "id": null,
                    "name": null,
                    "quality": null,
                    "iframeUrl": "https://92d73433.obrut.show/embed/MjM/content/ADOzITN"
                }
            ],
            "success": true,
            "updatedAt": "2024-12-04T07:55:09.8711883Z"
        },
        {
            "source": "Videocdn",
            "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751",
            "translations": [
                {
                    "id": null,
                    "name": "Дубляж",
                    "quality": null,
                    "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751"
                },
                {
                    "id": null,
                    "name": "Профессиональный (многоголосый закадровый)",
                    "quality": null,
                    "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751"
                },
                {
                    "id": null,
                    "name": "Гоблин | Пучков Дмитрий",
                    "quality": null,
                    "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751"
                },
                {
                    "id": null,
                    "name": "Карповский Антон",
                    "quality": null,
                    "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751"
                },
                {
                    "id": null,
                    "name": "Гаврилов Андрей",
                    "quality": null,
                    "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751"
                },
                {
                    "id": null,
                    "name": "[EN] Original (English)",
                    "quality": null,
                    "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751"
                },
                {
                    "id": null,
                    "name": "Киреев Антон",
                    "quality": null,
                    "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751"
                },
                {
                    "id": null,
                    "name": "Гланц + Королёва",
                    "quality": null,
                    "iframeUrl": "https://p.lumex.pw/gzIOdW6ZBYvH/movie/1751"
                }
            ],
            "success": true,
            "updatedAt": "2024-12-04T03:09:27.942588Z"
        },
        {
            "source": "Vibix",
            "iframeUrl": "https://667481665.videoframe1.com/embed/4973",
            "translations": [
                {
                    "id": null,
                    "name": null,
                    "quality": null,
                    "iframeUrl": "https://667481665.videoframe1.com/embed/4973"
                }
            ],
            "success": true,
            "updatedAt": "2024-12-04T09:20:49.9970915Z"
        },
        {
            "source": "Kodik",
            "iframeUrl": null,
            "translations": [],
            "success": true,
            "updatedAt": "2024-12-04T05:35:45.3535937Z"
        }
    ]
*/


const searchBtn = document.querySelector('.btn-search');
const searchInput = document.getElementById('search-input');
const movieCardContainer = document.querySelector('.wrapper');
const formSearch = document.querySelector('.form-search');
const dropdownContainer = document.getElementById('dropdown-container');


const headers = {
    "X-API-KEY": "H1WGZ9Y-VT04R1D-KFYYYQ2-ZDB00S5"
};


let state = {
    movie: {},
    error: '',
    isloadedListVisible: false,
    loadedList: [],
    favoritesMovieList: [],
}


searchBtn.addEventListener('click', handleSearchMovieByName);
searchInput.addEventListener('input', handleShowAllMovies);

document.addEventListener('click', (event) => {
    if (formSearch.contains(event.target)) {
        return
    }

    state.isloadedListVisible = false;
    renderListOfMovies();
    searchInput.value = '';
});


function handleShowAllMovies(event) {
    event.preventDefault();
    state.isloadedListVisible = true;

    getMoviesByFirstLetters(searchInput.value).then(() => {
        renderListOfMovies();
    });
}


function getVideoMovieByID(id) {
    const url = `https://kinobox.tv/api/players?kinopoisk=${id}`;


    return fetch(url)
        .then((data) => {
            return data.json();
        }).then((responseVideoData) => {
            console.log(responseVideoData);
            return responseVideoData;
        })
}



let counter = 0;

function getMoviesByFirstLetters(name, page = 1, limit = 30) {
    counter++;
    const localCount = counter
    const url = `https://api.kinopoisk.dev/v1.4/movie/search?query=${name}&limit=${limit}&page=${page}`;

    // return new Promise((resolve, reject) => {
    //     setTimeout(() => {
    //         if (counter === localCount) {
    //             resolve(MOCK_DATA)
    //         }
    //     }, 1500);
    // }).then((responseData) => {
    //     getListOfMovies(responseData);
    // })

    return fetch(url, {
        headers: headers
    }).then((data) => {
        if (counter === localCount) {
            return data.json();
        }

    }).then((responseData) => {
        if (responseData) {
            getListOfMovies(responseData);
        }
    })
}


function getListOfMovies(responseData) {
    //получаем данные по фильмам по введенным значениям

    state.loadedList = responseData.docs.filter((movieData) => {
        return movieData.rating.kp > 5;
    });
}


function showExistedInfo(data) {
    return Number(data) > 0 ? data.toFixed(1) : ``;
}


function showAge(data) {
    return Number(data) > 0 ? data.toFixed(0) : `0`;
}


function createList() {
    const list = state.loadedList.map((movieEl) => {
        return `<div class="dropdown-movie-item" id = '${movieEl.id}'>${movieEl.name} 
                    <span class="dropdown-movie-rating">${showExistedInfo(movieEl.rating.kp)}</span>
                </div>`
    }).slice(0, 10);

    return list.join(' ');
}


//отрисовка выпадающего списка и слушатель на клик по одному из выпадающего списка фильму
function renderListOfMovies() {
    //рендерим список фильмов по введенным значениям
    dropdownContainer.innerHTML = state.isloadedListVisible ? `<div class="dropdown-list-movies">
                                 ${createList()}
                                 </div>` : '';

    const dropdownListMovies = dropdownContainer.querySelector('.dropdown-list-movies');

    //слушатель, если клик по одному из фильмов
    if (dropdownListMovies) {
        dropdownListMovies.addEventListener('click', handleFindMovieIdAtDropdownList);
    }
}


//поиск данных по фильму из выпадающего списка в поиске
function handleFindMovieIdAtDropdownList(event) {
    // debugger
    let parentNode = event.target.closest('.dropdown-movie-item');

    let parentNodeId = parentNode.id;
    const nameMovie = document.getElementById(parentNodeId).firstChild.textContent.trim();

    let chosenMovie = state.loadedList.find((movieData) => {
        return movieData.name === nameMovie;
    })

    getVideoMovieByID(parentNodeId)
        .then((responseVideoData) => {
            updateMovieInfo({docs: [chosenMovie]}, responseVideoData);
            renderCardOfMovie();
            saveToLocalStorage();        
    })
}


function handleSearchMovieByName(event) {
    event.preventDefault();

    if (!searchInput.value) {
        return;
    }

    let responseData = null;

    getMoviesByName(searchInput.value)
        .then((_responseData) => {
            responseData = _responseData;
            console.log(_responseData);
            return getVideoMovieByID(_responseData.docs[0].id);
        }).then((responseVideoData) => {
        updateMovieInfo(responseData, responseVideoData);
        renderCardOfMovie();
        saveToLocalStorage();
    })
}


function getMoviesByName(name, page = 1, limit = 1) {
    const url = `https://api.kinopoisk.dev/v1.4/movie/search?query=${name}&limit${limit}&page${page}`;

    return fetch(url, {
        headers: headers
    }).then((data) => {
        return data.json();
    }).then((responseData) => {
        return responseData;

        // if (responseData.error) {
        //     state.error = 'Ошибка!';
        //     return new Error(state.error);
        // } else {
        //     updateMovieInfo(responseData);
        //     state.error = '';
        // }
        // searchInput.value = '';
    })
}


function updateMovieInfo(responseData, responseVideoData) {

    state.movie = {
        poster: responseData?.docs[0].poster?.url,
        name: responseData?.docs[0].name,
        year: responseData?.docs[0].year,
        alternativeName: responseData?.docs[0].alternativeName,
        ageRating: responseData?.docs[0].ageRating,
        shortDescription: responseData?.docs[0].shortDescription,
        countryName: responseData?.docs[0].countries[0]?.name,
        genres: responseData?.docs[0].genres,
        movieLength: responseData?.docs[0].movieLength,
        ratingKp: responseData?.docs[0].rating?.kp,
        votesKp: responseData?.docs[0].votes?.kp,
        filmCritics: responseData?.docs[0].votes?.filmCritics,
        description: responseData?.docs[0].description,
        idMovie: responseData?.docs[0].id,
        selectedVideoPlayer: responseVideoData[1].source,
    
        videoPlayers: responseVideoData.filter((obj) => {
            return obj.source !== 'Alloha' 
            && obj.iframeUrl
        }).map((videoPlayer) => {
            return {
                source: videoPlayer.source,
                iframeUrl: videoPlayer.iframeUrl,
            }
        })
    }
}



function countHoursAndMinutes(minutes) {
    let hours = Math.floor(minutes / 60);
    return `${hours} ч ${minutes - (hours * 60)} мин`;
}



function createGenresHTML() {
    const genresAll = state.movie.genres.map((genre) => {
        return `<a href="#">${genre.name}</a>`;
    })

    return genresAll.join(',  ');
}



function createPlayerList() {
    const playersAll = state.movie.videoPlayers.map((players) => {
        return `<option id = "${players.source}"  ${ players.source ===  state.movie.selectedVideoPlayer ? 'selected' : ``} >${players.source}</option>`;
    })

    return playersAll.join(' ');
}



function renderCardOfMovie() {
    movieCardContainer.innerHTML = '';

    const movieCardHTML = `<div class="wrapper-col-1">
            <img src="${state.movie.poster}" alt="${state.movie.name} ${(state.movie.year)}" >
        </div>
        <div class="wrapper-col-2">
            <div id = "add-to-favorites"> 
                <span>Добавить в избранное</span> 
                <span id = "favorites-img">${renderFavoritesBtn()}</span>
            </div>
            <h1 class="title">${state.movie.name} (${state.movie.year})</h1>
            <h6 class="subtitle">${state.movie.alternativeName} ${showAge(state.movie.ageRating)}+</h6>
            <p class="description">${state.movie.shortDescription}</p>

            <div class="mb-40">
                <a href="#" class="btn" id = "watch-btn">Смотреть</a>
            </div>

            <ul class="params mb-40">
                <li><span class="text-muted">Аудиодорожки </span>Русский</li>
                <li><span class="text-muted">Возраст </span><span><span class="tag">${showAge(state.movie.ageRating)}+</span></span></li>
            </ul>

            <h2>О фильме</h2>

            <ul class="params">
                <li><span class="text-muted">Год производства </span>${state.movie.year}</li>
                <li><span class="text-muted">Страна </span>${state.movie.countryName}</li>
                <li><span class="text-muted">Жанр </span>
                <span class="genres-list">${createGenresHTML()}</span>
                </li>
                <li><span class="text-muted">Время </span>
                    <time class="text-muted">${state.movie.movieLength} мин. / ${countHoursAndMinutes(state.movie.movieLength)}</time>
                </li>
                <li><span class="text-muted">Описание </span>${state.movie.description}</li>
            </ul>

                <div class="kinobox_player">
                    <select id = "select-player">
                    ${createPlayerList()}
                    </select>
                    
                    <iframe controls id = "iframe-player" src="${getIframeBySource()}" width="100%" height="500px" style = "border: 1px solid #aaa; border-radius: 3px;">
                    </iframe>
                </div>
        </div>
        
       
        <div class="wrapper-col-3">
            <span class="rating-main">${(state.movie.ratingKp).toFixed(1)}</span>
            <span class="rating-counts">${(state.movie.votesKp).toLocaleString()} оценки</span>
            <a href="#" class="rating-details">${state.movie.filmCritics} рецензий</a>

            <h4 class = "favorites-title"> Мое избранное </h4>   
            <div id="favorites-list">${renderFavoriteMovieList()}</div> 
        </div>`


    movieCardContainer.insertAdjacentHTML('afterbegin', movieCardHTML);

    const selectPlayer = document.getElementById('select-player');
    selectPlayer.addEventListener('change', handleSearchPlayerAtSelect);

    //перелистывание до контейнера с видеоплеером
    const watchBtn = document.getElementById('watch-btn');
    watchBtn.addEventListener('click', () => {
        document.getElementById('iframe-player').scrollIntoView({behavior: "smooth",});
    })

    //смена сердечка при клике
    const addToFavorites = document.getElementById('add-to-favorites');
    addToFavorites.addEventListener('click', handleClickFavorites);


    //переход по клику на фильм в Избранном
    const favoritesList = document.getElementById('favorites-list');

    if (favoritesList) {
        favoritesList.addEventListener('click', handleFindMovieIdAtFavoriteList);
    }

}


function handleFindMovieIdAtFavoriteList(event) {
    let parentNode = event.target.closest('.favorite-movie-item');

    let responseData = null;

    getMoviesByName(parentNode.innerText)
        .then((responseData) => {
            responseData = _responseData;
            return getVideoMovieByID(parentNode.id)
        }).then((responseVideoData) => {
            console.log(responseData);
            updateMovieInfo(responseData, responseVideoData);
            renderCardOfMovie();
            saveToLocalStorage();
        })
   
}



//получение данных по выбранному видеоплееру
function getIframeBySource() {
    
     let chosenPlayer = state.movie.videoPlayers.find((player) => {
        return player.source === state.movie.selectedVideoPlayer;
    })


    return chosenPlayer.iframeUrl;
}


//выбор плеера из выпадающего списка и отрисовка
function handleSearchPlayerAtSelect(event) {
    state.movie.selectedVideoPlayer = event.target.value;

    renderCardOfMovie();
}


//клик, чтобы добавить в избранное
function handleClickFavorites() {
        const chooseFavorite = state.favoritesMovieList.find((favMovie) => {
            return favMovie.id === state.movie.idMovie;
        });


        if (!chooseFavorite) {      
            state.favoritesMovieList.push({
                //проверяю, что его нет в списке избранных фильмов
                name: state.movie.name, 
                poster: state.movie.poster, 
                id: state.movie.idMovie
            });
        }   else {
            //если повторно жму на фильм, который уже есть в списке избранного
                state.favoritesMovieList = state.favoritesMovieList.filter((favMovie) => {
                return favMovie.id !== state.movie.idMovie;

            })
        }

    
    renderCardOfMovie();
    saveToLocalStorage();
}

//получить данные по изб фильмам и отрисовать 
function renderFavoriteMovieList() {
    //отрисовываем по полученным данным
    const favoriteMovieList = state.favoritesMovieList.map((favoriteEl) => {
        return `<div class = "favorite-movie-item" id = "${favoriteEl.id}">
                    <img id = "favorite-movie-poster" src = "${favoriteEl.poster}"> <div class="favorite-movie-name">${favoriteEl.name}
                    </div>
                </div>`
    })
    return favoriteMovieList.join(' ');
}


//отрисовка на закрашенное/незакрашенное сердечко
function renderFavoritesBtn() {
    const chooseFavorite = state.favoritesMovieList.find((favMovie) => {
        return favMovie.id === state.movie.idMovie;
    });

    return chooseFavorite ? `<ion-icon name="heart"></ion-icon>` : `<ion-icon name="heart-outline"></ion-icon>`;

}


function saveToLocalStorage() {
    localStorage.setItem('state', JSON.stringify(state));
}


if (localStorage.getItem('state')) {
    // get - получить данные по ключу (в данном случае ключ: state)
    state = JSON.parse(localStorage.getItem('state'));
    renderCardOfMovie();
}
